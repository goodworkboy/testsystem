<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liugx.testsystem.mapper.UserTestMapper">
  <resultMap id="BaseResultMap" type="com.liugx.testsystem.dto.UserTestDTO">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Nov 09 08:42:32 CST 2020.
    -->
    <id column="test_id" jdbcType="BIGINT" property="testId" />
    <result column="name" jdbcType="VARCHAR" property="testName" />
    <result column="status" jdbcType="BIT" property="status" />
    <result column="start_time" jdbcType="BIGINT" property="startTime" />
    <result column="end_time" jdbcType="BIGINT" property="endTime" />
    <result column="duration" jdbcType="BIGINT" property="duration" />
  </resultMap>
  
  <resultMap id="UserRowDTO" type="com.liugx.testsystem.dto.UserRowDTO">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Nov 09 08:42:32 CST 2020.
    -->
    <id column="user_id" jdbcType="BIGINT" property="userId" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="score" jdbcType="INTEGER" property="score" />
    <result column="use_time" jdbcType="BIGINT" property="useTime" />
    <result column="row" jdbcType="INTEGER" property="row" />
  </resultMap>
  
  
  <select id="selectStartingTest" parameterType="com.liugx.testsystem.dto.UserTestQueryDTO" resultMap="BaseResultMap">
  	select test.id as test_id,test.duration as duration,
  	test.start_time as start_time,test.end_time as end_time,test.name as name,userandtest.status as status
  	from userandtest inner join test on userandtest.test_id=test.id 
  	where userandtest.user_id = #{userId} and test.start_time &lt;= #{currentTime} and test.end_time > #{currentTime}
  	limit #{offset},#{size};
  </select>
  
  <select id="countStartingTest" parameterType="com.liugx.testsystem.dto.UserTestQueryDTO" resultType="java.lang.Integer">
  	select count(1)
  	from userandtest inner join test on userandtest.test_id=test.id
  	where userandtest.user_id = #{userId} and test.start_time &lt;= #{currentTime} and test.end_time > #{currentTime}
  </select>
  
  <select id="sumTotalScore" parameterType="com.liugx.testsystem.model.UserTestInfo"  resultType="java.lang.Integer">
  	select sum(score) from usertestInfo where user_id=#{userId} and test_id =#{testId} group by user_id,test_id;
  </select>
  
  <select id="countUserOfTest" parameterType="com.liugx.testsystem.dto.RowQueryDTO"  resultType="java.lang.Integer">
  	select count(1) 
  	from userandtest inner join user on userandtest.user_id = user.id
  	 where test_id =#{testId};
  </select>
  
  <select id="selectRow" parameterType="com.liugx.testsystem.dto.RowQueryDTO"  resultMap="UserRowDTO">
  	select user.id as user_id,user.name as user_name, userandtest.score as score , 
  	userandtest.end_time-userandtest.start_time as use_time 
  	from userandtest inner join user on userandtest.user_id = user.id
  	 where userandtest.test_id =#{testId}
  	 order by score desc,use_time asc
  	 limit #{offset},#{size};
  </select>
  <select id="selectUserReport" parameterType="com.liugx.testsystem.dto.RowQueryDTO"  resultMap="UserRowDTO">
  	select B.* from(
  		select T.*, @num := @num + 1 as 'row' from
		(select user.id as user_id,user.name as user_name, userandtest.score as score , 
	  	userandtest.end_time-userandtest.start_time as use_time 
	  	from userandtest inner join user on userandtest.user_id = user.id
	  	 where userandtest.test_id =#{testId}
	  	 order by score desc,use_time asc) as T,(select @num := 0) R
  	) as B where B.user_id = #{userId};
  </select>
  
 
</mapper>